# GEO-SCOPE API Deploy Workflow
# Backend API auto-deploy + automatic database migrations
#
# Migration System:
# - Uses migrations/runner.py to automatically detect and run pending migrations
# - Tracks applied migrations in schema_migrations table
# - Idempotent: safe to run multiple times
#
# Triggers:
# - Push to develop with Backend/** changes        â†’ test (auto-migrate)
# - Push to product with Backend/** changes        â†’ release (auto-migrate)
# - PR to product with Backend/** changes          â†’ test (validation)
# - PR merged with Backend/** changes              â†’ release (auto-migrate)
# - workflow_dispatch                              â†’ manual selection

name: Deploy API

on:
  push:
    branches: [develop, product]
    paths:
      - 'Backend/**'
      - '.github/workflows/deploy-api.yml'

  pull_request:
    branches: [product]
    paths:
      - 'Backend/**'

  pull_request_target:
    types: [closed]
    branches: [product]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'test'
        type: choice
        options: [test, release]
      run_migration:
        description: 'Run database migrations'
        type: boolean
        default: false

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      deploy_env: ${{ steps.check.outputs.deploy_env }}
      run_migration: ${{ steps.check.outputs.run_migration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changes
        id: check
        uses: ./.github/actions/check-changes
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          check_paths: 'Backend'
          manual_environment: ${{ github.event.inputs.environment }}
          manual_migration: ${{ github.event.inputs.run_migration }}

  deploy:
    needs: check
    if: needs.check.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    env:
      DEPLOY_ENV: ${{ needs.check.outputs.deploy_env }}
      RUN_MIGRATION: ${{ needs.check.outputs.run_migration }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # For pull_request_target, use the merge commit SHA to ensure we deploy merged code
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.merge_commit_sha || github.ref }}

      - name: Deploy info
        run: |
          echo "ðŸŒ Environment: $DEPLOY_ENV"
          echo "ðŸ—„ï¸ Migration: $RUN_MIGRATION"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          if [ "$DEPLOY_ENV" = "release" ]; then
            echo "${{ secrets.PROD_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
            echo " Target: geo-scope.ai"
          else
            echo "${{ secrets.DEV_SSH_KEY_B64 }}" | base64 -d > ~/.ssh/deploy_key
            echo "ðŸ§ª Target: dev.geo-scope.ai"
          fi
          chmod 600 ~/.ssh/deploy_key

      - name: Sync files
        run: |
          TARGET=$( [ "$DEPLOY_ENV" = "release" ] && echo "/www/wwwroot/geo-scope.ai/api/" || echo "/www/wwwroot/dev.geo-scope.ai/api/" )

          rsync -avz --delete \
            --exclude='.env' --exclude='.venv/' --exclude='__pycache__/' \
            --exclude='*.pyc' --exclude='.pytest_cache/' \
            --exclude='geo_scope.db*' --exclude='*.db-journal' \
            --exclude='static/avatars/**' --exclude='static/images/**' --exclude='static/uploads/**' \
            --exclude='api/static/**' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            Backend/ root@${{ secrets.SERVER_HOST }}:${TARGET}

          # Ensure static subdirectories exist (they may be excluded from rsync)
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} \
            "mkdir -p ${TARGET}static/avatars ${TARGET}static/images ${TARGET}static/uploads"

      - name: Install, migrate, restart
        run: |
          if [ "$DEPLOY_ENV" = "release" ]; then
            TARGET="/www/wwwroot/geo-scope.ai/api"
            SERVICE="geo-scope-api-release"
            APP_ENV="release"
          else
            TARGET="/www/wwwroot/dev.geo-scope.ai/api"
            SERVICE="geo-scope-api-test"
            APP_ENV="test"
          fi

          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} << ENDSSH
            set -e
            cd $TARGET
            export PATH="\$HOME/.local/bin:\$PATH"

            # Python env
            command -v uv || curl -LsSf https://astral.sh/uv/install.sh | sh
            [ -d ".venv" ] || uv venv .venv
            source .venv/bin/activate
            uv pip install -r requirements.txt

            # Migrations - Always run the migration runner
            # It automatically detects and executes pending migrations
            echo "ðŸ—„ï¸ Running migration runner..."
            APP_ENV=$APP_ENV python -m migrations.runner || {
              echo "âš ï¸ Migration runner failed, check logs"
              # Don't fail deployment for migration errors in test env
              [ "$DEPLOY_ENV" = "release" ] && exit 1 || true
            }

            # Restart
            systemctl restart $SERVICE
            sleep 2
            systemctl status $SERVICE --no-pager || true
          ENDSSH

      - name: Health check
        run: |
          URL=$( [ "$DEPLOY_ENV" = "release" ] && echo "https://geo-scope.ai/health" || echo "https://dev.geo-scope.ai/health" )
          for i in 1 2 3 4 5; do
            curl -sf "$URL" && echo "âœ… OK" && exit 0
            sleep 5
          done
          exit 1
