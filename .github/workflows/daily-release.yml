# GEO-SCOPE Daily Release Workflow
# æ¯å¤©æ–°åŠ å¡æ—¶é—´ 23:59 æ£€æŸ¥ product åˆ†æ”¯æ˜¯å¦æœ‰å½“å¤©çš„æäº¤
# å¦‚æžœæœ‰æäº¤ï¼Œè‡ªåŠ¨è§¦å‘ summary ç”Ÿæˆå’Œæ‰“åŒ…å‘å¸ƒ
#
# æ—¶åŒºè¯´æ˜Ž:
#   - Singapore (SGT) = UTC+8
#   - SGT 23:59 = UTC 15:59

name: Daily Release

on:
  schedule:
    # æ¯å¤© UTC 15:59 è¿è¡Œ (æ–°åŠ å¡æ—¶é—´ 23:59)
    - cron: '59 15 * * *'

  # æ‰‹åŠ¨è§¦å‘ï¼ˆç”¨äºŽæµ‹è¯•ï¼‰
  workflow_dispatch:
    inputs:
      force_release:
        description: 'å¼ºåˆ¶å‘å¸ƒï¼ˆå¿½ç•¥æ˜¯å¦æœ‰å½“å¤©æäº¤ï¼‰'
        type: boolean
        default: false

env:
  RELEASE_SERVER_URL: ${{ secrets.RELEASE_SERVER_URL || 'https://releases.geo-scope.ai' }}

jobs:
  check-commits:
    runs-on: ubuntu-latest
    outputs:
      has_commits: ${{ steps.check.outputs.has_commits }}
      commit_count: ${{ steps.check.outputs.commit_count }}
      commits_json: ${{ steps.check.outputs.commits_json }}

    steps:
      - name: Checkout product branch
        uses: actions/checkout@v4
        with:
          ref: product
          fetch-depth: 0

      - name: Check for today's commits
        id: check
        run: |
          # èŽ·å–æ–°åŠ å¡æ—¶é—´çš„ä»Šå¤©æ—¥æœŸ
          TODAY=$(TZ='Asia/Singapore' date +%Y-%m-%d)
          echo "ðŸ“… Checking commits for: $TODAY (Singapore Time)"

          # èŽ·å–ä»Šå¤©ï¼ˆæ–°åŠ å¡æ—¶é—´ï¼‰çš„ commits
          # ä½¿ç”¨ --since å’Œ --until ç¡®ä¿åªèŽ·å–å½“å¤©çš„ commits
          SINCE="${TODAY}T00:00:00+08:00"
          UNTIL="${TODAY}T23:59:59+08:00"

          echo "ðŸ“ Time range: $SINCE to $UNTIL"

          # ç»Ÿè®¡ä»Šå¤©çš„ commit æ•°é‡
          COMMIT_COUNT=$(git log --oneline --since="$SINCE" --until="$UNTIL" | wc -l | tr -d ' ')

          echo "ðŸ“Š Found $COMMIT_COUNT commits today"

          if [ "$COMMIT_COUNT" -gt 0 ] || [ "${{ github.event.inputs.force_release }}" = "true" ]; then
            echo "has_commits=true" >> $GITHUB_OUTPUT

            # èŽ·å–ä»Šå¤©çš„ commits è¯¦æƒ…ï¼ˆç”¨äºŽ AI summaryï¼‰
            COMMITS_JSON=$(git log --since="$SINCE" --until="$UNTIL" --pretty=format:'%h%x00%s' | \
              jq -Rs 'split("\n") | map(select(length > 0) | split("\u0000") | {hash: .[0], message: .[1]})')

            # å¦‚æžœæ˜¯å¼ºåˆ¶å‘å¸ƒä½†æ²¡æœ‰ä»Šå¤©çš„ commitsï¼ŒèŽ·å–æœ€æ–°çš„ commit
            if [ "$COMMIT_COUNT" -eq 0 ] && [ "${{ github.event.inputs.force_release }}" = "true" ]; then
              echo "âš ï¸ Force release: using latest commit"
              COMMITS_JSON=$(git log -1 --pretty=format:'%h%x00%s' | \
                jq -Rs 'split("\n") | map(select(length > 0) | split("\u0000") | {hash: .[0], message: .[1]})')
              COMMIT_COUNT=1
            fi

            {
              echo "commits_json<<COMMITS_EOF"
              echo "$COMMITS_JSON"
              echo "COMMITS_EOF"
            } >> $GITHUB_OUTPUT

            echo "âœ… Will trigger release"
          else
            echo "has_commits=false" >> $GITHUB_OUTPUT
            echo "commits_json=[]" >> $GITHUB_OUTPUT
            echo "â­ï¸ No commits today, skipping release"
          fi

          echo "commit_count=$COMMIT_COUNT" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "## Daily Release Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(TZ='Asia/Singapore' date '+%Y-%m-%d %H:%M:%S SGT')" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits today**: ${{ steps.check.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Will release**: ${{ steps.check.outputs.has_commits }}" >> $GITHUB_STEP_SUMMARY

  # è§¦å‘å‘å¸ƒæµç¨‹
  trigger-release:
    needs: check-commits
    if: needs.check-commits.outputs.has_commits == 'true'
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: product
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Calculate version
        id: version
        run: |
          # è‡ªåŠ¨è®¡ç®—ç‰ˆæœ¬å·
          VERSION=$(node scripts/version.js)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: Generate AI Summary
        id: ai_summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TODAY=$(TZ='Asia/Singapore' date +%Y-%m-%d)

          # è¯»å– commits JSON (ä½¿ç”¨ jq -c åŽ‹ç¼©å¹¶éªŒè¯ JSON æ ¼å¼)
          COMMITS='${{ needs.check-commits.outputs.commits_json }}'

          # éªŒè¯å¹¶åŽ‹ç¼© JSON (ç§»é™¤ç©ºç™½ä½†ä¿æŒç»“æž„)
          if ! COMMITS=$(echo "$COMMITS" | jq -c '.' 2>/dev/null); then
            echo "âš ï¸ Invalid commits JSON, using empty array"
            COMMITS='[]'
          fi

          echo "ðŸ¤– Generating AI-powered changelog summary..."
          echo "ðŸ“ Commits: $COMMITS"

          # æž„å»ºè¯·æ±‚
          REQUEST_BODY=$(jq -n \
            --arg version "$VERSION" \
            --argjson commits "$COMMITS" \
            --arg date "$TODAY" \
            --arg author "daily-release" \
            '{version: $version, commits: $commits, date: $date, author_username: $author, save_to_db: true}')

          # è°ƒç”¨ Summary API
          HTTP_RESPONSE=$(curl -s -L -w "\n%{http_code}" -X POST "${{ env.RELEASE_SERVER_URL }}/api/summary/generate" \
            -H "Content-Type: application/json" \
            -H "X-API-Key: ${{ secrets.RELEASE_API_KEY }}" \
            --connect-timeout 30 \
            --max-time 120 \
            -d "$REQUEST_BODY" 2>&1)

          HTTP_CODE=$(echo "$HTTP_RESPONSE" | tail -n1)
          SUMMARY_RESPONSE=$(echo "$HTTP_RESPONSE" | sed '$d')

          echo "ðŸ“¡ HTTP Status: $HTTP_CODE"

          SUCCESS=$(echo "$SUMMARY_RESPONSE" | jq -r '.success // false')
          if [ "$SUCCESS" = "true" ]; then
            echo "âœ… AI changelog generated"
            NOTES_EN=$(echo "$SUMMARY_RESPONSE" | jq -r '.notes.en // "Daily release"')
            NOTES_ZH=$(echo "$SUMMARY_RESPONSE" | jq -r '.notes.zh // "æ¯æ—¥å‘å¸ƒ"')
          else
            echo "âš ï¸ AI summary failed, using default"
            NOTES_EN="Daily release $VERSION"
            NOTES_ZH="æ¯æ—¥å‘å¸ƒ $VERSION"
          fi

          echo "notes_en=$NOTES_EN" >> $GITHUB_OUTPUT
          echo "notes_zh=$NOTES_ZH" >> $GITHUB_OUTPUT

      - name: Trigger Release Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.version.outputs.version }}';
            const notes_zh = '${{ steps.ai_summary.outputs.notes_zh }}';
            const notes_en = '${{ steps.ai_summary.outputs.notes_en }}';

            console.log(`ðŸš€ Triggering release workflow for version ${version}`);

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yml',
              ref: 'product',
              inputs: {
                version: version,
                notes_zh: notes_zh,
                notes_en: notes_en,
                is_critical: 'false',
                is_prerelease: 'false'
              }
            });

            console.log('âœ… Release workflow triggered');

      - name: Summary
        run: |
          echo "## Daily Release Triggered" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commits**: ${{ needs.check-commits.outputs.commit_count }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Release Notes" >> $GITHUB_STEP_SUMMARY
          echo "**EN**: ${{ steps.ai_summary.outputs.notes_en }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ZH**: ${{ steps.ai_summary.outputs.notes_zh }}" >> $GITHUB_STEP_SUMMARY

  # æ²¡æœ‰æäº¤æ—¶çš„é€šçŸ¥
  no-release:
    needs: check-commits
    if: needs.check-commits.outputs.has_commits == 'false'
    runs-on: ubuntu-latest

    steps:
      - name: Log skip
        run: |
          echo "â­ï¸ No commits on product branch today, skipping release"
          echo "## Daily Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No commits found on product branch for today (Singapore Time)." >> $GITHUB_STEP_SUMMARY
