# Composite Action: æ£€æŸ¥ä»£ç å˜æ›´å¹¶å†³å®šéƒ¨ç½²ç­–ç•¥
# ç»Ÿä¸€å¤„ç† push / pull_request / pull_request_target / workflow_dispatch
#
# Note: Migrations are now handled automatically by migrations/runner.py
# The runner detects and executes pending migrations on every deployment

name: 'Check Changes'
description: 'æ£€æŸ¥ PR/Push çš„æ–‡ä»¶å˜æ›´ï¼Œå†³å®šæ˜¯å¦éƒ¨ç½²åŠéƒ¨ç½²ç¯å¢ƒ'

inputs:
  github_token:
    description: 'GitHub Token for API calls'
    required: true
  check_paths:
    description: 'éœ€è¦æ£€æŸ¥çš„è·¯å¾„å‰ç¼€ (é€—å·åˆ†éš”ï¼Œå¦‚ Backend,Frontend)'
    required: false
    default: 'Backend,Frontend'
  manual_environment:
    description: 'æ‰‹åŠ¨è§¦å‘æ—¶çš„ç¯å¢ƒé€‰æ‹©'
    required: false
    default: ''
  manual_migration:
    description: 'æ‰‹åŠ¨è§¦å‘æ—¶æ˜¯å¦è¿è¡Œè¿ç§»'
    required: false
    default: 'false'

outputs:
  should_run:
    description: 'æ˜¯å¦åº”è¯¥æ‰§è¡Œåç»­ job'
    value: ${{ steps.check.outputs.should_run }}
  deploy_env:
    description: 'éƒ¨ç½²ç¯å¢ƒ (test/release)'
    value: ${{ steps.check.outputs.deploy_env }}
  run_migration:
    description: 'æ˜¯å¦è¿è¡Œæ•°æ®åº“è¿ç§»'
    value: ${{ steps.check.outputs.run_migration }}
  has_backend:
    description: 'æ˜¯å¦æœ‰ Backend å˜æ›´'
    value: ${{ steps.check.outputs.has_backend }}
  has_frontend:
    description: 'æ˜¯å¦æœ‰ Frontend å˜æ›´'
    value: ${{ steps.check.outputs.has_frontend }}
  has_migrations:
    description: 'æ˜¯å¦æœ‰ migrations å˜æ›´'
    value: ${{ steps.check.outputs.has_migrations }}
  is_release:
    description: 'æ˜¯å¦ä¸ºæ­£å¼å‘å¸ƒ (tag æˆ–æ‰‹åŠ¨)'
    value: ${{ steps.check.outputs.is_release }}
  trigger_type:
    description: 'è§¦å‘ç±»å‹ (push/pr/pr_merged/manual/tag)'
    value: ${{ steps.check.outputs.trigger_type }}

runs:
  using: 'composite'
  steps:
    - name: Check changes and determine deployment
      id: check
      shell: bash
      env:
        GH_TOKEN: ${{ inputs.github_token }}
        CHECK_PATHS: ${{ inputs.check_paths }}
        MANUAL_ENV: ${{ inputs.manual_environment }}
        MANUAL_MIGRATION: ${{ inputs.manual_migration }}
      run: |
        set -e

        # åˆå§‹åŒ–è¾“å‡º
        SHOULD_RUN="false"
        DEPLOY_ENV="test"
        RUN_MIGRATION="false"
        HAS_BACKEND="false"
        HAS_FRONTEND="false"
        HAS_MIGRATIONS="false"
        IS_RELEASE="false"
        TRIGGER_TYPE=""
        CHANGED_FILES=""

        EVENT="${{ github.event_name }}"
        REF="${{ github.ref }}"
        BASE_REF="${{ github.event.pull_request.base.ref }}"

        echo "=========================================="
        echo "ğŸ“¦ Event: $EVENT"
        echo "ğŸ”€ Ref: $REF"
        echo " Check paths: $CHECK_PATHS"
        echo "=========================================="

        # =============================================
        # 1. ç¡®å®šè§¦å‘ç±»å‹å’ŒåŸºæœ¬å‚æ•°
        # =============================================

        if [ "$EVENT" = "workflow_dispatch" ]; then
          TRIGGER_TYPE="manual"
          SHOULD_RUN="true"
          IS_RELEASE="true"
          DEPLOY_ENV="${MANUAL_ENV:-test}"
          RUN_MIGRATION="$MANUAL_MIGRATION"
          echo "âœ… Manual trigger â†’ $DEPLOY_ENV"

        elif [ "$EVENT" = "push" ] && [[ "$REF" == refs/tags/v* ]]; then
          TRIGGER_TYPE="tag"
          SHOULD_RUN="true"
          IS_RELEASE="true"
          DEPLOY_ENV="release"
          RUN_MIGRATION="true"
          echo "âœ… Tag push â†’ release"

        elif [ "$EVENT" = "push" ]; then
          TRIGGER_TYPE="push"
          # push äº‹ä»¶å·²ç»é€šè¿‡ workflow çš„ paths è¿‡æ»¤
          SHOULD_RUN="true"
          # push åˆ° product åˆ†æ”¯éƒ¨ç½²åˆ° releaseï¼Œå…¶ä»–åˆ†æ”¯éƒ¨ç½²åˆ° test
          if [[ "$REF" == "refs/heads/product" ]]; then
            DEPLOY_ENV="release"
            echo "âœ… Push to product â†’ release"
          else
            DEPLOY_ENV="test"
            echo "âœ… Push to branch â†’ test"
          fi

        elif [ "$EVENT" = "pull_request" ]; then
          TRIGGER_TYPE="pr"
          # PR äº‹ä»¶å·²ç»é€šè¿‡ workflow çš„ paths è¿‡æ»¤
          SHOULD_RUN="true"
          DEPLOY_ENV="test"
          echo "âœ… PR opened/updated â†’ test (éªŒè¯)"

        elif [ "$EVENT" = "pull_request_target" ]; then
          TRIGGER_TYPE="pr_merged"

          # =============================================
          # å®‰å…¨æ£€æŸ¥ (å»ºè®®1: å®‰å…¨è¾¹ç•Œ)
          # =============================================

          # æ£€æŸ¥ 1: å¿…é¡»æ˜¯ merged çŠ¶æ€
          if [ "${{ github.event.pull_request.merged }}" != "true" ]; then
            echo "â­ï¸ PR closed without merge â†’ skip"
            SHOULD_RUN="false"
          # æ£€æŸ¥ 2: å¿…é¡»åˆå¹¶åˆ° product åˆ†æ”¯
          elif [ "$BASE_REF" != "product" ]; then
            echo "âš ï¸ PR merged to $BASE_REF (not product) â†’ skip"
            SHOULD_RUN="false"
          else
            # è·å– PR å˜æ›´æ–‡ä»¶
            PR_NUMBER="${{ github.event.pull_request.number }}"
            echo "ğŸ” Checking PR #$PR_NUMBER files..."

            CHANGED_FILES=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/files \
              --jq '.[].filename' 2>/dev/null || echo "")

            if [ -z "$CHANGED_FILES" ]; then
              echo "âš ï¸ Could not fetch PR files â†’ skip"
              SHOULD_RUN="false"
            else
              # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å…³æ³¨çš„è·¯å¾„å˜æ›´
              IFS=',' read -ra PATHS <<< "$CHECK_PATHS"
              for path in "${PATHS[@]}"; do
                if echo "$CHANGED_FILES" | grep -q "^${path}/"; then
                  SHOULD_RUN="true"
                  break
                fi
              done

              if [ "$SHOULD_RUN" = "true" ]; then
                DEPLOY_ENV="release"
                echo "âœ… PR merged with relevant changes â†’ release"
              else
                echo "â­ï¸ PR merged but no relevant changes â†’ skip"
              fi
            fi
          fi

        else
          echo "âš ï¸ Unknown event: $EVENT â†’ skip"
          SHOULD_RUN="false"
        fi

        # =============================================
        # 2. åˆ†æå…·ä½“å˜æ›´å†…å®¹ (å»ºè®®3: ç²¾ç¡®æ£€æµ‹)
        # =============================================

        if [ "$SHOULD_RUN" = "true" ]; then
          # å¯¹äº push/PR äº‹ä»¶ï¼Œä» git diff è·å–å˜æ›´
          if [ -z "$CHANGED_FILES" ] && [ "$TRIGGER_TYPE" != "manual" ] && [ "$TRIGGER_TYPE" != "tag" ]; then
            if [ -n "${{ github.event.before }}" ] && [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ]; then
              CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")
            fi
          fi

          # æ£€æµ‹å„ç±»å˜æ›´
          if echo "$CHANGED_FILES" | grep -q "^Backend/"; then
            HAS_BACKEND="true"
            echo "  ğŸ“¦ Has Backend changes"
          fi

          if echo "$CHANGED_FILES" | grep -q "^Frontend/"; then
            HAS_FRONTEND="true"
            echo "  ğŸ¨ Has Frontend changes"
          fi

          if echo "$CHANGED_FILES" | grep -q "^Backend/migrations/"; then
            HAS_MIGRATIONS="true"
            echo "  ğŸ—„ï¸ Has migrations changes"
          fi

          # =============================================
          # 3. Migration Runner (è‡ªåŠ¨å¤„ç†)
          # =============================================
          #
          # è¿ç§»ç°åœ¨ç”± migrations/runner.py è‡ªåŠ¨å¤„ç†:
          # - è‡ªåŠ¨æ£€æµ‹å¾…æ‰§è¡Œçš„è¿ç§»
          # - é€šè¿‡ schema_migrations è¡¨è·Ÿè¸ªå·²æ‰§è¡Œçš„è¿ç§»
          # - æ¯æ¬¡éƒ¨ç½²éƒ½ä¼šè¿è¡Œ runnerï¼Œå®ƒä¼šè‡ªåŠ¨åˆ¤æ–­éœ€è¦æ‰§è¡Œä»€ä¹ˆ
          #
          # RUN_MIGRATION ä¿ç•™ç”¨äºæ—¥å¿—è¾“å‡º
          RUN_MIGRATION="auto"
          if [ "$HAS_MIGRATIONS" = "true" ]; then
            echo "  ğŸ—„ï¸ New migrations detected, runner will apply them"
          else
            echo "  ğŸ—„ï¸ Migration runner will check for pending migrations"
          fi
        fi

        # =============================================
        # 4. è¾“å‡ºç»“æœ
        # =============================================

        echo ""
        echo "=========================================="
        echo "ğŸ“‹ Final Decision:"
        echo "   should_run:     $SHOULD_RUN"
        echo "   deploy_env:     $DEPLOY_ENV"
        echo "   run_migration:  $RUN_MIGRATION"
        echo "   has_backend:    $HAS_BACKEND"
        echo "   has_frontend:   $HAS_FRONTEND"
        echo "   has_migrations: $HAS_MIGRATIONS"
        echo "   is_release:     $IS_RELEASE"
        echo "   trigger_type:   $TRIGGER_TYPE"
        echo "=========================================="

        echo "should_run=$SHOULD_RUN" >> $GITHUB_OUTPUT
        echo "deploy_env=$DEPLOY_ENV" >> $GITHUB_OUTPUT
        echo "run_migration=$RUN_MIGRATION" >> $GITHUB_OUTPUT
        echo "has_backend=$HAS_BACKEND" >> $GITHUB_OUTPUT
        echo "has_frontend=$HAS_FRONTEND" >> $GITHUB_OUTPUT
        echo "has_migrations=$HAS_MIGRATIONS" >> $GITHUB_OUTPUT
        echo "is_release=$IS_RELEASE" >> $GITHUB_OUTPUT
        echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT
